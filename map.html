<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carte interactive Hexvia - D√©partements</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      html, body {
        margin: 0;
        height: 100%;
        font-family: system-ui, sans-serif;
      }
      #map { height: 100vh; width: 100%; }

      .logo-container {
        position: fixed;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 6px 10px;
        box-shadow: 0 0 6px rgba(0,0,0,0.25);
        z-index: 9999;
      }
      .logo-container img { height: 60px; background:white; padding:6px; border-radius:8px; }

      .filter-container {
        position: fixed;
        top: 95px;
        right: 15px;
        z-index: 9999;
        background: rgba(255,255,255,0.95);
        padding: 10px 12px;
        border-radius: 8px;
        box-shadow: 0 0 6px rgba(0,0,0,0.25);
      }
      .filter-container select {
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid #aaa;
        font-size: 14px;
      }

      .legend {
        position: fixed;
        bottom: 15px;
        left: 15px;
        z-index: 9999;
        background: rgba(255,255,255,0.95);
        padding: 12px 14px;
        font-size: 13px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.25);
        line-height: 1.8;
        max-width: 250px;
      }
      .legend-marker {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid white;
        display: inline-block;
        margin-right: 6px;
      }

      .legend-gradient {
        display: flex;
        align-items: center;
        margin-top: 8px;
        gap: 6px;
      }
      .gradient-bar {
        width: 150px;
        height: 20px;
        background: linear-gradient(to right, #e8f5e9, #a5d6a7, #66bb6a, #43a047, #2e7d32);
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .search-container {
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 9999;
        width: 260px;
      }
      .search-container input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #aaa;
        font-size: 14px;
        background:#fff;
      }
      .results-list {
        background: rgba(255,255,255,0.95);
        max-height: 200px;
        overflow-y: auto;
        border-radius: 6px;
        margin-top: 4px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        display: none;
      }
      .result-item { padding: 6px 10px; cursor: pointer; border-bottom: 1px solid #eee; }
      .result-item:hover { background: #f5f5f5; }

      .popup-content { color:#000; font-size:13px; line-height:1.4; width: 230px; }
      .popup-buttons { display:flex; justify-content:space-between; margin-top:8px; gap:4px; }
      .popup-btn {
        flex:1; padding:6px 8px; border:none; border-radius:4px; font-size:12px; cursor:pointer;
        font-weight:600; color:white; transition:transform .15s ease, background .3s;
      }
      .popup-btn:hover { transform: scale(1.05); }
      .btn-dir { background:#1976d2; } .btn-dir:hover { background:#1565c0; }
      .btn-contact { background:#4caf50; } .btn-contact:hover { background:#449d48; }

      .google-btn {
        display:inline-block; margin-top:6px; background:#1a73e8; color:#fff!important;
        padding:5px 8px; border-radius:4px; text-decoration:none; font-weight:600; font-size:12px;
      }
      .google-btn:hover { background:#1669c1; }

      #splash-screen {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.85);
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        z-index: 10000; transition: opacity 0.8s ease; backdrop-filter: blur(4px);
      }
      #splash-screen img { width: 160px; margin-bottom: 25px; }
      #progress { margin-top: 8px; font-size: 15px; color: #ccc; font-weight: 600; }
      .progress-bar {
        width: 250px; height: 10px; background: rgba(255,255,255,0.2);
        border-radius: 5px; margin-top: 12px; overflow: hidden; box-shadow: inset 0 0 5px rgba(0,0,0,0.25);
      }
      .progress-bar-inner { height: 100%; width: 0%; background: #4caf50; transition: width 0.3s ease; }

    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="search-container">
      <input type="text" id="searchInput" placeholder="üîç Rechercher une agence..." />
      <div class="results-list" id="resultsList"></div>
    </div>

    <div class="logo-container">
      <img src="https://i.ibb.co/35w511m5/logo-hexvia.png" alt="Logo Hexvia" />
    </div>

    <div class="filter-container">
      <select id="filterType">
        <option value="all">üìç Toutes les agences</option>
        <option value="integree">üü¢ Int√©gr√©es</option>
        <option value="franchisee">üîµ Franchis√©es</option>
        <option value="demeseul">‚ö´ Demeseul</option>
      </select>
    </div>

    <div class="legend">
      <div class="legend-section">
        <b>Types d'agences</b><br />
        <span class="legend-marker" style="background:#2e7d32;"></span> Int√©gr√©e<br />
        <span class="legend-marker" style="background:#1565c0;"></span> Franchis√©e<br />
        <span class="legend-marker" style="background:#424242;"></span> Demeseul
      </div>
      <div class="legend-section">
        <b>Densit√© par d√©partement</b><br />
        <div class="legend-gradient">
          <span style="font-size:11px;">0</span>
          <div class="gradient-bar"></div>
          <span style="font-size:11px;">Max</span>
        </div>
      </div>
    </div>

    <div id="splash-screen">
      <img src="https://i.ibb.co/35w511m5/logo-hexvia.png" alt="Hexvia" />
      <p style="color:#fff;margin:0 0 8px;">Chargement des d√©partements et agences...</p>
      <div id="progress">0%</div>
      <div class="progress-bar"><div class="progress-bar-inner" id="progressBarInner"></div></div>
    </div>

    <script>
      window.addEventListener('load', function() {
        initMap();
      });

      const AIRTABLE_TOKEN = 'patCagDMpXwNLGyQu.ed05d2b62289d165c562eed44a9e04b7f424b708179f288461a499caebe77ac4';
      const BASE_ID = 'app5DoZKkIuqd6Quo';
      const TABLE_ID = 'tblcLGQDcypZPFbZA';

      let map;
      let markers = [];
      let departmentsLayer = null;

      function initMap() {
        map = L.map('map').setView([46.5, 2.5], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap'
        }).addTo(map);

        initSearch();
        main();
      }

      function detectType(type, type2) {
        const t = (type || type2 || '')
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

        if (t.includes("franch")) return "franchisee";
        if (t.includes("demeseul")) return "demeseul";
        if (t.includes("integr")) return "integree";
        return "unknown";
      }

      function buildIcon(type, googleNote) {
        let t = (type || '').toLowerCase().trim();

        let color = "#2e7d32"; 
        const typeNormalized = t.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

        if (typeNormalized.includes("franchise")) {
          color = "#1565c0";
        } else if (typeNormalized.includes("demeseul")) {
          color = "#424242";
        }

        let halo = "";
        if (googleNote) {
          const n = parseFloat(String(googleNote).replace(",", "."));
          if (!isNaN(n)) {
            if (n >= 4.5) halo = "box-shadow:0 0 12px rgba(255,215,0,0.9);";
            else if (n >= 4) halo = "box-shadow:0 0 8px rgba(255,215,0,0.6);";
            else if (n < 3) halo = "box-shadow:0 0 8px rgba(255,0,0,0.7);";
          }
        }

        return L.divIcon({
          html: `<div style="width:18px;height:18px;background:${color};border-radius:50%;border:2px solid #fff;${halo}"></div>`,
          className: "",
          iconSize: [20, 20],
          iconAnchor: [10, 10],
          popupAnchor: [0, -10],
        });
      }

      async function fetchAllRecords() {
        const baseUrl = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}`;
        let offset = null;
        const all = [];

        do {
          const url = new URL(baseUrl);
          url.searchParams.set("pageSize", "100");
          if (offset) url.searchParams.set("offset", offset);

          const res = await fetch(url, { headers:{ Authorization:`Bearer ${AIRTABLE_TOKEN}` } });
          const data = await res.json();

          (data.records || []).forEach(r => all.push(r));
          offset = data.offset;
        } while (offset);

        return all;
      }

      async function loadDepartmentsGeoJSON() {
        try {
          const response = await fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements.geojson');
          return await response.json();
        } catch (error) {
          console.error('Erreur lors du chargement des d√©partements:', error);
          return null;
        }
      }

      function findDepartment(lat, lng, geojson) {
        if (!geojson) return null;
        const point = [lng, lat];
        for (const feature of geojson.features) {
          if (pointInPolygon(point, feature.geometry)) {
            return feature.properties.code;
          }
        }
        return null;
      }

      function pointInPolygon(point, geometry) {
        if (geometry.type === 'Polygon') {
          return pointInPoly(point, geometry.coordinates[0]);
        } else if (geometry.type === 'MultiPolygon') {
          for (const polygon of geometry.coordinates) {
            if (pointInPoly(point, polygon[0])) return true;
          }
        }
        return false;
      }

      function pointInPoly(point, vs) {
        const x = point[0], y = point[1];
        let inside = false;
        for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
          const xi = vs[i][0], yi = vs[i][1];
          const xj = vs[j][0], yj = vs[j][1];
          const intersect = ((yi > y) !== (yj > y)) &&
                            (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      }

      function getColorForCount(count, maxCount) {
        if (count === 0) return '#f5f5f5';
        const ratio = count / maxCount;
        if (ratio < 0.2) return '#e8f5e9';
        if (ratio < 0.4) return '#a5d6a7';
        if (ratio < 0.6) return '#66bb6a';
        if (ratio < 0.8) return '#43a047';
        return '#2e7d32';
      }

      async function main() {
        const splash = document.getElementById('splash-screen');
        const progress = document.getElementById('progress');
        const bar = document.getElementById('progressBarInner');

        progress.textContent = "Chargement des d√©partements...";
        const geojson = await loadDepartmentsGeoJSON();
        bar.style.width = "30%";

        progress.textContent = "Chargement des agences...";
        const records = await fetchAllRecords();
        bar.style.width = "60%";

        const deptCount = {};
        const agenciesData = [];

        for (const rec of records) {
          const f = rec.fields || {};
          const lat = parseFloat(f["Latitude"]);
          const lng = parseFloat(f["Longitude"]);
          if (isNaN(lat) || isNaN(lng)) continue;

          const dept = findDepartment(lat, lng, geojson);
          if (dept) deptCount[dept] = (deptCount[dept] || 0) + 1;

          const agenceNameRaw = f["AGENCE "] || f["AGENCE"] || "Sans nom";

          agenciesData.push({
            lat,
            lng,
            name: agenceNameRaw,
            address: f["ADRESSE-OK"] || "",
            type: f["TYPE AGENCE"] || "",
            type2: f["TYPE 2"] || "",
            type3: f["TYPE 3"] || "",
            googleAvis: f["URL Avis Google"] || null,
            googleNote: f["NOTE_GOOGLE"] || null,
            googleCount: f["NOMBRE_AVIS_GOOGLE"] || null,
            avNote: f["NOTE_AV"] || null,
            avCount: f["NOMBRE_AVIS_AV"] || null,

            /* CHAMPS EXPLOITATION */
            EXPLOITANT: f["EXPLOITANT"] || "",
            MAIL_EXPLOITANT: f["MAIL_EXPLOITANT"] || "",
            NUMERO_EXPLOITANT: f["NUMERO_EXPLOITANT"] || "",

            /* CHAMPS DIRECTION */
            DIRECTION_MAIL: f["DIRECTION D'AGENCE"] || "",
            NUMERO_DIRECTION: f["NUMERO DEMECO.FR"] || ""
          });
        }

        progress.textContent = "Affichage des d√©partements...";
        const maxCount = Math.max(...Object.values(deptCount), 1);

        departmentsLayer = L.geoJSON(geojson, {
          style: feature => {
            const code = feature.properties.code;
            const count = deptCount[code] || 0;
            return {
              fillColor: getColorForCount(count, maxCount),
              fillOpacity: 0.6,
              color: '#666',
              weight: 1.5,
              opacity: 0.8
            };
          }
        }).addTo(map);

        bar.style.width = "80%";

        progress.textContent = "Ajout des agences...";

        let done = 0;
        for (const agency of agenciesData) {
          const {
            lat, lng,
            name, address,
            type, type2, type3,
            googleAvis,
            googleNote,
            googleCount,
            avNote,
            avCount,
            EXPLOITANT,
            MAIL_EXPLOITANT,
            NUMERO_EXPLOITANT,
            DIRECTION_MAIL,
            NUMERO_DIRECTION
          } = agency;

          let noteStyle = "";
          if (googleNote) {
            const n = parseFloat(String(googleNote).replace(",", "."));
            if (!isNaN(n)) {
              if (n >= 4) noteStyle = "color:#2e7d32;font-weight:bold;";
              else if (n >= 3) noteStyle = "color:#ff9800;font-weight:bold;";
              else noteStyle = "color:#e53935;font-weight:bold;";
            }
          }

          const googleBlock = googleNote
            ? `<div style="${noteStyle}">‚≠ê Google : ${googleNote}/5${googleCount ? ` (${googleCount} avis)` : ""}</div>`
            : "";

          const avBlock = avNote
            ? `<div style="color:#1565c0;font-weight:bold;">üèÜ AV : ${avNote}/5${avCount ? ` (${avCount} avis)` : ""}</div>`
            : "";

          const hasExploitation =
            (EXPLOITANT && EXPLOITANT.trim() !== "") ||
            (MAIL_EXPLOITANT && MAIL_EXPLOITANT.trim() !== "") ||
            (NUMERO_EXPLOITANT && NUMERO_EXPLOITANT.trim() !== "");

          const exploitationBlock = hasExploitation ? `
            <div class="exploitation-details" style="display:none;margin-top:8px;font-size:12px;">
              <b>Responsable Exploitation :</b> ${EXPLOITANT || "Non renseign√©"}<br>
              <b>Mail :</b> ${MAIL_EXPLOITANT || "Non renseign√©"}<br>
              <b>N¬∞ :</b> ${NUMERO_EXPLOITANT || "Non renseign√©"}
            </div>
          ` : "";

          const hasDirection =
            (DIRECTION_MAIL && DIRECTION_MAIL.trim() !== "") ||
            (NUMERO_DIRECTION && NUMERO_DIRECTION.trim() !== "");

          const directionName = getDirectionName(DIRECTION_MAIL);

          const directionBlock = hasDirection ? `
            <div class="direction-details" style="display:none;margin-top:8px;font-size:12px;">
              <b>Direction :</b> ${directionName}<br>
              <b>Mail :</b> ${DIRECTION_MAIL || "Non renseign√©"}<br>
              <b>N¬∞ :</b> ${NUMERO_DIRECTION || "Non renseign√©"}
            </div>
          ` : "";

          const directionButtonHTML = hasDirection
            ? `<button class="popup-btn btn-dir" onclick="toggleDirection(this)">Direction</button>`
            : "";

          const exploitationButtonHTML = hasExploitation
            ? `<button class="popup-btn btn-contact" onclick="toggleExploitation(this)">Exploitation</button>`
            : "";

          const popupHTML = `
            <div class="popup-content">
              <strong style="font-size:14px;">${name}</strong><br>
              üè¢ <em>${type2 || type}</em><br>
              üìç ${address}<br>
              ${googleBlock}
              ${avBlock}
              ${googleAvis ? `<a href="${googleAvis}" class="google-btn" target="_blank">Voir les avis Google</a>` : ``}

              <div class="popup-buttons">
                ${directionButtonHTML}
                ${exploitationButtonHTML}
              </div>

              ${directionBlock}
              ${exploitationBlock}
            </div>
          `;

          const marker = L.marker([lat, lng], {
            icon: buildIcon(type, googleNote)
          })
          .addTo(map)
          .bindPopup(popupHTML);

          markers.push({ name, type, type2, type3, marker });

          done++;
          const pct = 80 + Math.round((done / agenciesData.length) * 20);
          bar.style.width = pct + "%";
        }

        let triAdded = false;
        let traAdded = false;

        markers.forEach(m => {
          if (!m.type3) return;
          const t3 = m.type3.toLowerCase();

          if (t3.includes("tri") && !triAdded) {
            const opt = document.createElement("option");
            opt.value = "tri";
            opt.textContent = "üöß TRI";
            document.getElementById("filterType").appendChild(opt);
            triAdded = true;
          }

          if (t3.includes("tra") && !traAdded) {
            const opt = document.createElement("option");
            opt.value = "tra";
            opt.textContent = "üöö TRA";
            document.getElementById("filterType").appendChild(opt);
            traAdded = true;
          }
        });

        document.getElementById("filterType").addEventListener("change", applyFilter);

        progress.textContent = "100%";
        bar.style.width = "100%";

        setTimeout(() => splash.style.opacity = 0, 500);
        setTimeout(() => splash.remove(), 1200);
      }

      function applyFilter() {
        const value = document.getElementById("filterType").value;

        markers.forEach(m => {
          const t = detectType(m.type, m.type2);
          let show = false;

          if (value === "all") show = true;
          else if (t === value) show = true;

          if (m.type3) {
            const t3 = m.type3.toLowerCase();
            if (value === "tri" && t3.includes("tri")) show = true;
            if (value === "tra" && t3.includes("tra")) show = true;
          }

          if (show) map.addLayer(m.marker);
          else map.removeLayer(m.marker);
        });
      }

      function initSearch() {
        const searchInput = document.getElementById("searchInput");
        const resultsList = document.getElementById("resultsList");

        searchInput.addEventListener("input", () => {
          const q = searchInput.value.trim().toLowerCase();
          resultsList.innerHTML = "";
          if (!q) return resultsList.style.display = "none";

          const filtered = markers.filter(m =>
            m.name.toLowerCase().includes(q) ||
            m.type.toLowerCase().includes(q) ||
            (m.type2 && m.type2.toLowerCase().includes(q)) ||
            (m.type3 && m.type3.toLowerCase().includes(q))
          );

          if (filtered.length === 0) {
            resultsList.innerHTML = "<div class='result-item'>Aucune agence trouv√©e</div>";
            return resultsList.style.display = "block";
          }

          filtered.forEach(m => {
            const item = document.createElement("div");
            item.className = "result-item";
            item.innerHTML = `<b>${m.name}</b><br><small>${m.type2 || m.type}</small>`;
            item.onclick = () => {
              map.setView(m.marker.getLatLng(), 13);
              m.marker.openPopup();
              resultsList.style.display = "none";
            };
            resultsList.appendChild(item);
          });

          resultsList.style.display = "block";
        });
      }

      function getDirectionName(mail) {
        if (!mail || !mail.includes("@") || !mail.includes(".")) return "Non renseign√©";
        const beforeAt = mail.split("@")[0]; // nom.prenom
        const parts = beforeAt.split(".");
        if (parts.length < 2) return "Non renseign√©";

        const nom = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
        const prenom = parts[1].charAt(0).toUpperCase() + parts[1].slice(1);

        return `${prenom} ${nom}`;
      }

      function toggleExploitation(btn) {
        const container = btn.closest('.popup-content').querySelector('.exploitation-details');
        if (!container) return;

        const isVisible = container.style.display === "block";
        container.style.display = isVisible ? "none" : "block";

        btn.textContent = isVisible ? "Exploitation" : "Masquer";
      }

      function toggleDirection(btn) {
        const container = btn.closest('.popup-content').querySelector('.direction-details');
        if (!container) return;

        const isVisible = container.style.display === "block";
        container.style.display = isVisible ? "none" : "block";

        btn.textContent = isVisible ? "Direction" : "Masquer";
      }
    </script>
  </body>
</html>
