<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carte interactive Hexvia - D√©partements</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      html, body { margin: 0; height: 100%; font-family: system-ui, sans-serif; }
      #map { height: 100vh; width: 100%; }

      .logo-container { position: fixed; top: 15px; right: 15px; background: rgba(255,255,255,0.9); border-radius: 10px; padding: 6px 10px; box-shadow: 0 0 6px rgba(0,0,0,0.25); z-index: 9999; }
      .logo-container img { height: 60px; background:white; padding:6px; border-radius:8px; }

      .legend { position: fixed; bottom: 15px; left: 15px; z-index: 9999; background: rgba(255,255,255,0.95); padding: 12px 14px; font-size: 13px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.25); line-height: 1.8; max-width: 250px; }
      .legend-marker { width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; display: inline-block; margin-right: 6px; }

      .search-container { position: fixed; top: 15px; left: 15px; z-index: 9999; width: 260px; }
      .search-container input { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #aaa; font-size: 14px; background:#fff; }

      .results-list { background: rgba(255,255,255,0.95); max-height: 200px; overflow-y: auto; border-radius: 6px; margin-top: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.25); display: none; }
      .result-item { padding: 6px 10px; cursor: pointer; border-bottom: 1px solid #eee; }
      .result-item:hover { background: #f5f5f5; }

      .popup-content { color:#000; font-size:13px; line-height:1.4; width: 230px; }
      .popup-buttons { display:flex; justify-content:space-between; margin-top:8px; gap:4px; }
      .popup-btn { flex:1; padding:6px 8px; border:none; border-radius:4px; font-size:12px; cursor:pointer; font-weight:600; color:white; transition:transform .15s ease, background .3s; }
      .btn-dir { background:#1976d2; } .btn-dir:hover { background:#1565c0; }
      .btn-contact { background:#4caf50; } .btn-contact:hover { background:#449d48; }

      .google-btn { display:inline-block; margin-top:6px; background:#1a73e8; color:#fff!important; padding:5px 8px; border-radius:4px; text-decoration:none; font-weight:600; font-size:12px; }

      #splash-screen {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.85);
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        z-index: 10000;
        transition: opacity 0.8s ease; backdrop-filter: blur(4px);
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <div class="search-container">
      <input type="text" id="searchInput" placeholder="üîç Rechercher une agence..." />
      <div class="results-list" id="resultsList"></div>
    </div>

    <div class="logo-container">
      <img src="https://i.ibb.co/35w511m5/logo-hexvia.png" alt="Logo Hexvia" />
    </div>

    <script>
      /* ---------- AVIS CSV (AJOUT√â UNIQUEMENT) ---------- */
      const AVIS_URL =
        "https://raw.githubusercontent.com/directiondigitaldemecogroup-spec/StreamLitCarteDemeco/refs/heads/main/avis.csv";

      let avisData = {};

      async function loadAvisCSV() {
        const res = await fetch(AVIS_URL);
        const text = await res.text();

        const lines = text.split("\n").filter(l => l.trim().length > 0);
        const headers = lines[0].split(";");

        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(";");

          const entry = {};
          headers.forEach((h, idx) => entry[h.trim()] = cols[idx]?.trim() || "");

          avisData[entry["AGENCE"]] = entry;
        }

        console.log("Avis charg√©s :", avisData);
      }
      /* ----------------- SCRIPT ORIGINAL ----------------- */

      window.addEventListener('load', function () { initMap(); });

      const AIRTABLE_TOKEN = 'patCagDMpXwNLGyQu.ed05d2b62289d165c562eed44a9e04b7f424b708179f288461a499caebe77ac4';
      const BASE_ID = 'app5DoZKkIuqd6Quo';
      const TABLE_ID = 'tblcLGQDcypZPFbZA';

      let map;
      let markers = [];
      let departmentsLayer = null;

      function initMap() {
        map = L.map('map').setView([46.5, 2.5], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap'
        }).addTo(map);

        initSearch();

        main();
      }

      /* ---------- Correction du bug (t d√©clar√© 2 fois) ---------- */
      function buildIcon(type) {
        let t = (type || '').toLowerCase().trim();

        let color = "#2e7d32"; // integr√©e par d√©faut
        if (t.includes("franchise")) color = "#1565c0";
        if (t.includes("demeseul")) color = "#424242";

        return L.divIcon({
          html: `<div style="width:18px;height:18px;background:${color};border-radius:50%;border:2px solid #fff;"></div>`,
          className: "",
          iconSize: [20, 20],
          iconAnchor: [10, 10],
          popupAnchor: [0, -10],
        });
      }

      async function fetchAllRecords() {
        const baseUrl = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}`;
        let offset = null;
        const all = [];

        do {
          const url = new URL(baseUrl);
          url.searchParams.set("pageSize", "100");
          if (offset) url.searchParams.set("offset", offset);

          const res = await fetch(url, { headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` } });
          const data = await res.json();

          (data.records || []).forEach(r => all.push(r));
          offset = data.offset;
        } while (offset);

        return all;
      }

      async function loadDepartmentsGeoJSON() {
        try {
          const response = await fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements.geojson');
          return await response.json();
        } catch (error) {
          console.error('Erreur GeoJSON:', error);
          return null;
        }
      }

      function getColorForCount(count, maxCount) {
        if (count === 0) return '#f5f5f5';
        const ratio = count / maxCount;

        if (ratio < 0.2) return '#e8f5e9';
        if (ratio < 0.4) return '#a5d6a7';
        if (ratio < 0.6) return '#66bb6a';
        if (ratio < 0.8) return '#43a047';
        return '#2e7d32';
      }

      async function main() {

        /* ---------- On charge d‚Äôabord les AVIS CSV ---------- */
        await loadAvisCSV();

        const records = await fetchAllRecords();

        for (const rec of records) {
          const f = rec.fields || {};
          const lat = parseFloat(f["Latitude"]);
          const lng = parseFloat(f["Longitude"]);

          if (isNaN(lat) || isNaN(lng)) continue;

          /* ---------- nom exact Airtable ---------- */
          const name = f["AGENCE "] || f["AGENCE"] || "Sans nom";

          /* ---------- On recherche les avis pour cette agence ---------- */
          const avis = avisData[name] || {};

          const noteGoogle = avis["NOTE GOOGLE"] || "";
          const nbGoogle = avis["AVIS GOOGLE"] || "";

          const noteAV = avis["NOTE AV"] || "";
          const nbAV = avis["AVIS AV"] || "";

          let avisHTML = "";
          if (noteGoogle) avisHTML += `<div>‚≠ê Google : <b>${noteGoogle}</b> (${nbGoogle} avis)</div>`;
          if (noteAV) avisHTML += `<div>üí¨ Avis V√©rifi√©s : <b>${noteAV}</b> (${nbAV} avis)</div>`;

          /* ---------- Popup HTML ---------- */
          const popupHTML = `
            <div class="popup-content">
              <strong style="font-size:14px;">${name}</strong><br>
              üè¢ <em>${f["TYPE 2"] || f["TYPE AGENCE"]}</em><br>
              üìç ${f["ADRESSE-OK"] || ""}<br><br>

              ${avisHTML}

              <div class="popup-buttons">
                <button class="popup-btn btn-dir"
                  onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}', '_blank')">
                  Itin√©raire
                </button>
                <button class="popup-btn btn-contact">Contact</button>
              </div>
            </div>
          `;

          const marker = L.marker([lat, lng], {
            icon: buildIcon(f["TYPE AGENCE"])
          })
          .addTo(map)
          .bindPopup(popupHTML);

          markers.push({
            name,
            type: f["TYPE AGENCE"],
            type2: f["TYPE 2"],
            marker
          });
        }
      }
      /* ---------- Recherche ---------- */
      function initSearch() {
        const searchInput = document.getElementById("searchInput");
        const resultsList = document.getElementById("resultsList");

        searchInput.addEventListener("input", () => {
          const q = searchInput.value.trim().toLowerCase();
          resultsList.innerHTML = "";
          if (!q) return resultsList.style.display = "none";

          const filtered = markers.filter(m =>
            m.name.toLowerCase().includes(q) ||
            (m.type && m.type.toLowerCase().includes(q)) ||
            (m.type2 && m.type2.toLowerCase().includes(q))
          );

          if (filtered.length === 0) {
            resultsList.innerHTML = "<div class='result-item'>Aucune agence trouv√©e</div>";
            return resultsList.style.display = "block";
          }

          filtered.forEach(m => {
            const item = document.createElement("div");
            item.className = "result-item";
            item.innerHTML = `<b>${m.name}</b><br><small>${m.type2 || m.type}</small>`;
            item.onclick = () => {
              map.setView(m.marker.getLatLng(), 13);
              m.marker.openPopup();
              resultsList.style.display = "none";
            };
            resultsList.appendChild(item);
          });

          resultsList.style.display = "block";
        });
      }
    </script>

  </body>
</html>

