<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carte interactive Hexvia - D√©partements</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    html, body { margin:0; height:100%; font-family:system-ui,sans-serif; }
    #map { height:100vh; width:100%; }

    /* LOGO */
    .logo-container {
      position: fixed; top: 15px; right: 15px;
      background: rgba(255,255,255,0.9);
      border-radius: 10px; padding: 6px 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
      z-index: 9999;
    }
    .logo-container img { height: 60px; background:white; padding:6px; border-radius:8px; }

    /* FILTRE */
    .filter-container {
      position: fixed; top: 95px; right: 15px; z-index:9999;
      background: rgba(255,255,255,0.95);
      padding:10px 12px; border-radius:8px;
      box-shadow:0 0 8px rgba(0,0,0,0.25);
    }
    .filter-container select {
      padding:6px 8px; width:180px;
      font-size:14px; border-radius:6px; border:1px solid #aaa;
    }

    /* LEGENDE */
    .legend {
      position: fixed; bottom: 15px; left: 15px; z-index: 9999;
      background: rgba(255,255,255,0.95);
      padding:12px 14px; border-radius:8px;
      box-shadow:0 0 10px rgba(0,0,0,0.25);
      font-size:13px; line-height:1.8;
    }
    .legend-marker {
      width:14px; height:14px; border-radius:50%;
      border:2px solid white; display:inline-block; margin-right:6px;
    }
    .gradient-bar {
      width:150px; height:20px;
      background:linear-gradient(to right,#e8f5e9,#a5d6a7,#66bb6a,#43a047,#2e7d32);
      border:1px solid #ccc; border-radius:4px;
    }

    /* RECHERCHE */
    .search-container {
      position: fixed; top:15px; left:15px; z-index:9999; width:260px;
    }
    .search-container input {
      width:100%; padding:8px 10px; border-radius:6px;
      border:1px solid #aaa; font-size:14px; background:#fff;
    }
    .results-list {
      background:rgba(255,255,255,0.95);
      max-height:200px; overflow-y:auto; border-radius:6px;
      margin-top:4px; box-shadow:0 2px 6px rgba(0,0,0,0.25);
      display:none;
    }
    .result-item { padding:6px 10px; cursor:pointer; border-bottom:1px solid #eee; }
    .result-item:hover { background:#f5f5f5; }

    /* POPUPS */
    .popup-content { font-size:13px; line-height:1.5; }
    .info-row { margin-top:4px; }

    /* Splash */
    #splash-screen {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.85); backdrop-filter:blur(4px);
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      z-index:10000; transition:opacity .8s ease;
    }
    #progress { color:#fff; margin-top:10px; font-size:14px; }
    .progress-bar {
      width:250px; height:10px; background:rgba(255,255,255,0.2);
      border-radius:5px; margin-top:10px; overflow:hidden;
    }
    .progress-bar-inner {
      height:100%; width:0%; background:#4caf50; transition:width .3s ease;
    }

    .dept-tooltip {
      background:rgba(0,0,0,0.8); color:white;
      padding:6px 10px; border-radius:4px;
      font-size:12px; font-weight:600;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="search-container">
  <input id="searchInput" type="text" placeholder="üîç Rechercher une agence..." />
  <div id="resultsList" class="results-list"></div>
</div>

<div class="logo-container">
  <img src="https://i.ibb.co/35w511m5/logo-hexvia.png" />
</div>

<div class="filter-container">
  <select id="filterType">
    <option value="all">üìç Toutes les agences</option>
    <option value="integr√©e">üü¢ Int√©gr√©es</option>
    <option value="franchis√©e">üîµ Franchis√©es</option>
    <option value="demeseul">‚ö´ Demeseul</option>
  </select>
</div>

<div class="legend">
  <b>Types d'agences</b><br>
  <span class="legend-marker" style="background:#2e7d32"></span> Int√©gr√©e<br>
  <span class="legend-marker" style="background:#1565c0"></span> Franchis√©e<br>
  <span class="legend-marker" style="background:#424242"></span> Demeseul<br><br>

  <b>Densit√© par d√©partement</b><br>
  <div class="gradient-bar"></div>
</div>

<div id="splash-screen">
  <img src="https://i.ibb.co/35w511m5/logo-hexvia.png" />
  <p style="color:white;">Chargement des donn√©es...</p>
  <div id="progress">0%</div>
  <div class="progress-bar"><div id="progressBarInner" class="progress-bar-inner"></div></div>
</div>

<script>
/* ============================================================= */
/* CONFIG */
/* ============================================================= */

const AIRTABLE_TOKEN = "patCagDMpXwNLGyQu.ed05d2b62289d165c562eed44a9e04b7f424b708179f288461a499caebe77ac4";  // ‚Üê mets ta vraie cl√©
const BASE_ID = "app5DoZKkIuqd6Quo";
const TABLE_ID = "tblcLGQDcypZPFbZA";

const CSV_URL = "https://raw.githubusercontent.com/directiondigitaldemecogroup-spec/StreamLitCarteDemeco/refs/heads/main/avis.csv";

let map;
let markers = [];
let departmentsLayer = null;
let csvData = {}; // index√© par nom d‚Äôagence


/* ============================================================= */
/* CHARGER CSV */
/* ============================================================= */
async function loadCSV() {
  const response = await fetch(CSV_URL);
  const text = await response.text();

  const rows = text.split("\n").map(r => r.trim());
  const headers = rows[0].split(",");

  const data = {};

  for (let i=1; i<rows.length; i++) {
    const cols = rows[i].split(",");
    if (cols.length < headers.length) continue;

    const row = {};
    headers.forEach((h, idx) => row[h.trim()] = cols[idx]?.trim());

    const agencyName = (row["AGENCE"] || "").trim();
    if (agencyName) data[agencyName] = row;
  }

  return data;
}


/* ============================================================= */
/* DETECT TYPE */
/* ============================================================= */
function detectType(type1, type2) {
  const t = (type1 || type2 || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"");

  if (t.includes("franch")) return "franchise";
  if (t.includes("demeseul")) return "demeseul";
  if (t.includes("integr")) return "integree";
  return "unknown";
}


/* ============================================================= */
/* ICON */
/* ============================================================= */
function buildIcon(type, googleNote) {
  const detected = detectType(type, null);
  let color = "#2e7d32";
  if (detected === "franchise") color = "#1565c0";
  if (detected === "demeseul") color = "#424242";

  return L.divIcon({
    html:`<div style="width:18px;height:18px;background:${color};
      border-radius:50%;border:2px solid #fff;"></div>`,
    className:"", iconSize:[20,20], iconAnchor:[10,10], popupAnchor:[0,-10]
  });
}


/* ============================================================= */
/* FILTRE */
/* ============================================================= */
function applyFilter() {
  const value = document.getElementById("filterType").value.toLowerCase();

  markers.forEach(m => {
    const t = detectType(m.type, m.type2);
    let show = false;

    if (value==="all") show = true;
    else if (value==="integr√©e" && t==="integree") show = true;
    else if (value==="franchis√©e" && t==="franchise") show = true;
    else if (value==="demeseul" && t==="demeseul") show = true;

    if (show) map.addLayer(m.marker);
    else map.removeLayer(m.marker);
  });
}


/* ============================================================= */
/* FETCH AIRTABLE */
/* ============================================================= */
async function fetchAllRecords() {
  const baseUrl = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_ID}`;
  let offset = null;
  const all = [];

  do {
    const url = new URL(baseUrl);
    url.searchParams.set("pageSize","100");
    if (offset) url.searchParams.set("offset", offset);

    const res = await fetch(url, {
      headers:{ Authorization:`Bearer ${AIRTABLE_TOKEN}` }
    });

    const data = await res.json();
    (data.records||[]).forEach(r => all.push(r));
    offset = data.offset;

  } while (offset);

  return all;
}


/* ============================================================= */
/* GEOJSON */
/* ============================================================= */
async function loadDepartmentsGeoJSON() {
  const r = await fetch("https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements.geojson");
  return await r.json();
}

function pointInPoly(point, vs) {
  const x = point[0], y = point[1];
  let inside = false;
  for (let i=0,j=vs.length-1;i<vs.length;j=i++) {
    const xi=vs[i][0], yi=vs[i][1];
    const xj=vs[j][0], yj=vs[j][1];
    const intersect = ((yi>y)!==(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi)+xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

function pointInPolygon(point, geometry) {
  if (geometry.type==="Polygon")
    return pointInPoly(point, geometry.coordinates[0]);

  if (geometry.type==="MultiPolygon")
    for (const poly of geometry.coordinates)
      if (pointInPoly(point, poly[0])) return true;

  return false;
}


/* ============================================================= */
/* COULEUR D√âPARTEMENT */
/* ============================================================= */
function getColorForCount(count, max) {
  if (count===0) return "#f5f5f5";
  const r = count/max;
  if (r<0.2) return "#e8f5e9";
  if (r<0.4) return "#a5d6a7";
  if (r<0.6) return "#66bb6a";
  if (r<0.8) return "#43a047";
  return "#2e7d32";
}


/* ============================================================= */
/* MAIN */
/* ============================================================= */
window.addEventListener("load", main);

async function main() {
  const splash = document.getElementById("splash-screen");
  const progress = document.getElementById("progress");
  const bar = document.getElementById("progressBarInner");

  /* 1. LOAD CSV */
  progress.textContent="Chargement CSV...";
  csvData = await loadCSV();
  bar.style.width="15%";

  /* 2. LOAD GEOJSON */
  progress.textContent="Chargement d√©partements...";
  const geojson = await loadDepartmentsGeoJSON();
  bar.style.width="30%";

  /* 3. LOAD AIRTABLE */
  progress.textContent="Chargement agences...";
  const records = await fetchAllRecords();
  bar.style.width="60%";

  /* Count dept */
  const deptCount = {};
  const agenciesData = [];

  for (const rec of records) {
    const f = rec.fields || {};

    const name = (f["AGENCE "]||"").trim();
    const lat = parseFloat(f["Latitude"]);
    const lng = parseFloat(f["Longitude"]);

    if (isNaN(lat) || isNaN(lng)) continue;

    const dept = geojson.features.find(feat =>
      pointInPolygon([lng,lat], feat.geometry)
    )?.properties.code;

    if (dept) deptCount[dept]=(deptCount[dept]||0)+1;

    const csvRow = csvData[name] || {};

    agenciesData.push({
      lat, lng,
      name,
      address: f["ADRESSE-OK"] || "",
      type: f["TYPE AGENCE"] || "",
      type2: f["TYPE 2"] || "",
      googleNote: csvRow["NOTE GOOGLE"] || "",
      googleAvis: csvRow["AVIS GOOGLE"] || "",
      noteAV: csvRow["NOTE AV"] || "",
      avisAV: csvRow["AVIS AV"] || ""
    });
  }

  /* 4. afficher d√©partements */
  progress.textContent="Affichage d√©partements...";
  const max = Math.max(...Object.values(deptCount));

  departmentsLayer = L.geoJSON(geojson,{
    style: f=>{
      const code=f.properties.code;
      return {
        fillColor:getColorForCount(deptCount[code]||0, max),
        fillOpacity:.6, color:"#666", weight:1.2
      }
    }
  }).addTo(map);

  bar.style.width="80%";

  /* 5. MARKERS */
  progress.textContent="Affichage agences...";
  let done=0;

  for (const a of agenciesData) {

    const popupHTML = `
      <div class="popup-content">
        <strong style="font-size:15px">${a.name}</strong><br>
        üè¢ <em>${a.type2 || a.type}</em><br>
        üìç ${a.address}<br>

        <div class="info-row" style="margin-top:8px;">
          ${a.googleNote ? `‚≠ê <b>Google :</b> ${a.googleNote} (${a.googleAvis} avis)<br>` : ""}
          ${a.noteAV ? `‚≠ê <b>AV :</b> ${a.noteAV} (${a.avisAV} avis)<br>` : ""}
        </div>
      </div>
    `;

    const marker = L.marker([a.lat,a.lng], {
      icon: buildIcon(a.type, a.googleNote)
    })
    .addTo(map)
    .bindPopup(popupHTML);

    markers.push(a);
    markers[markers.length-1].marker = marker;

    done++;
    bar.style.width = (80 + (done/agenciesData.length)*20) + "%";
  }

  progress.textContent="100%";

  /* filtre */
  document.getElementById("filterType").addEventListener("change", applyFilter);

  setTimeout(()=> splash.style.opacity=0, 800);
  setTimeout(()=> splash.remove(), 1500);
}


/* ============================================================= */
/* SEARCH */
/* ============================================================= */
function initSearch() {
  const input = document.getElementById("searchInput");
  const list = document.getElementById("resultsList");

  input.addEventListener("input", ()=>{
    const q = input.value.trim().toLowerCase();
    list.innerHTML="";
    if (!q) return list.style.display="none";

    const filtered = markers.filter(m =>
      m.name.toLowerCase().includes(q) ||
      m.type.toLowerCase().includes(q) ||
      (m.type2 && m.type2.toLowerCase().includes(q))
    );

    if (!filtered.length) {
      list.innerHTML = "<div class='result-item'>Aucune agence trouv√©e</div>";
      return list.style.display="block";
    }

    filtered.forEach(m=>{
      const item=document.createElement("div");
      item.className="result-item";
      item.innerHTML=`<b>${m.name}</b><br><small>${m.type2 || m.type}</small>`;
      item.onclick=()=>{
        map.setView([m.lat,m.lng],14);
        m.marker.openPopup();
        list.style.display="none";
      };
      list.appendChild(item);
    });

    list.style.display="block";
  });
}


/* ============================================================= */
/* INIT MAP */
/* ============================================================= */
map = L.map("map").setView([46.5,2.5],6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ attribution:"¬© OpenStreetMap"}).addTo(map);
initSearch();

</script>

</body>
</html>
